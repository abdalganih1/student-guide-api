بالتأكيد، سأقوم بسرد تفصيلي حول النماذج، الاستعلامات، عملية إعداد المصادقة، واستخدامات الـ Middleware، الـ Requests، والـ Resources في مشروع دليل الطالب الخاص بك.

**سرد تفصيلي حول مكونات المشروع:**

في رحلة بناء تطبيق دليل الطالب في الجامعة الوطنية الخاصة باستخدام إطار عمل Laravel، مررنا بعدة مراحل أساسية، بدءًا من تصميم هيكل قاعدة البيانات وصولًا إلى بناء الواجهات الخلفية لـ API ولوحة تحكم الإدارة.

**النماذج (Models) والاستعلامات (Queries): أساس الوصول إلى البيانات**

في قلب أي تطبيق يعتمد على قاعدة بيانات، توجد **النماذج (Models)**. في مشروعنا، كل جدول في قاعدة البيانات يمثله نموذج Eloquent Model في مجلد `app/Models`. هذه النماذج هي أدواتنا الرئيسية للتفاعل مع الجداول. على سبيل المثال:

*   `App\Models\AdminUser`: يمثل جدول `admin_users` ويسهل إدارة مستخدمي لوحة التحكم.
*   `App\Models\Student`: يمثل جدول `students` ويدير بيانات الطلاب.
*   `App\Models\Specialization`: يمثل جدول `specializations` لبيانات الاختصاصات.
*   `App\Models\Course`: يمثل جدول `courses` لبيانات المقررات.
*   `App\Models\Instructor`: يمثل جدول `instructors` لأعضاء هيئة التدريس.
*   `App\Models\Project`: يمثل جدول `projects` لمشاريع التخرج.
*   `App\Models\UniversityMedia`: يمثل جدول `university_media` لوسائط المرافق الجامعية.
*   `App\Models\Event`: يمثل جدول `events` للفعاليات.
*   `App\Models\StudentCourseEnrollment`: يمثل جدول الربط `student_course_enrollments` بين الطلاب والمقررات.
*   `App\Models\StudentEventRegistration`: يمثل جدول الربط `student_event_registrations` بين الطلاب والفعاليات.
*   `App\Models\Notification`: يمثل جدول `notifications` للتنبيهات.
*   `App\Models\NotificationRecipient`: يمثل جدول الربط `notification_recipients` بين التنبيهات والطلاب المستلمين.

من خلال هذه النماذج، نستخدم **استعلامات Eloquent** لجلب البيانات ومعالجتها ضمن المتحكمات (Controllers). بعض أنواع الاستعلامات الشائعة التي استخدمناها:

*   **`Model::all()` أو `Model::get()`:** لجلب جميع السجلات من جدول معين.
*   **`Model::find($id)`:** لجلب سجل واحد بناءً على مفتاحه الأساسي (ويتم استخدامه تلقائيًا في Route Model Binding).
*   **`Model::where('column', 'value')->get()`:** لفلترة السجلات بناءً على شرط معين.
*   **`Model::orderBy('column', 'direction')->get()`:** لترتيب السجلات.
*   **`Model::latest()->get()`:** لترتيب السجلات تنازليًا حسب `created_at`.
*   **`Model::with('relationName')->get()` أو `Model::load('relationName')`:** لتحميل العلاقات المرتبطة (Eager Loading) لتجنب مشكلة N+1 وتحسين الأداء. على سبيل المثال، `$projects = Project::with(['specializations', 'supervisor'])->latest()->get();` يجلب المشاريع مع تحميل الاختصاصات والمشرفين المرتبطين.
*   **`Model::whereHas('relationName', function ($query) { ... })`:** للفلترة بناءً على شروط في العلاقة المرتبطة. استخدمنا هذا في فلترة المشاريع حسب الاختصاصات المرتبطة.
*   **`Model::paginate($perPage)`:** لتقسيم النتائج إلى صفحات، وهو أمر بالغ الأهمية لواجهات الـ API وقوائم لوحة التحكم لتجنب جلب عدد كبير من البيانات دفعة واحدة.

**التحكمات (Controllers): معالجة الطلبات والاستجابات**

في مجلد `app/Http/Controllers`، قمنا بتنظيم المتحكمات في مجلدين فرعيين رئيسيين:

*   **`Api`:** للمتحكمات التي تستجيب لطلبات تطبيق الموبايل وترجع بيانات بصيغة JSON.
*   **`Admin`:** للمتحكمات التي تتعامل مع منطق لوحة تحكم الإدارة على الويب وترجع Blade views.

كل دالة داخل المتحكم تستقبل `Request` (أو Form Request مُخصصة) وتقوم بمعالجة الطلب: جلب بيانات من النماذج باستخدام الاستعلامات، تطبيق منطق الأعمال، ثم إرجاع استجابة مناسبة (إما JSON للـ API أو view للويب).

على سبيل المثال:

*   `Api\CourseController` يحتوي على دوال مثل `index`, `show`, `getCoursesByYearLevel` لجلب وعرض بيانات المقررات لطلاب التطبيق.
*   `Admin\SpecializationController` يحتوي على دوال `index`, `create`, `store`, `show`, `edit`, `update`, `destroy` لإدارة بيانات الاختصاصات في لوحة التحكم.

**إعداد المصادقة (Authentication): حماية الوصول**

لبناء نظام مصادقة قوي لكل من الطلاب (لـ API) والمديرين (للوحة الويب)، اعتمدنا على ميزات المصادقة المدمجة في Laravel:

*   **للوحة تحكم الإدارة:** استخدمنا نظام المصادقة المبني على الجلسات (Session-based Authentication). هذا هو النوع الافتراضي لمصادقة الويب في Laravel.
    *   **تثبيت `laravel/ui`:** لإعداد المصادقة السريعة لواجهة الويب، استخدمنا حزمة `laravel/ui`:
        ```bash
        composer require laravel/ui
        php artisan ui bootstrap --auth # أو نوع الواجهة الأمامية المفضل لديك
        php artisan migrate # لتشغيل الهجرات الافتراضية ( users و password_resets)
        ```
        على الرغم من أننا قمنا بتعديل هجرة `users` لتصبح `students` وهجرة `password_resets` لتناسب احتياجاتنا (لمديري النظام والطلاب بشكل منفصل)، فإن هذا الأمر يوفر الهيكل الأساسي وملفات الـ views اللازمة للمصادقة.
    *   **إنشاء حارس مخصص (`admin_web`):** قمنا بتعريف حارس جديد اسمه `admin_web` في `config/auth.php` باستخدام الـ provider الخاص بـ `AdminUser` (`admins`). هذا يمكّننا من فصل مصادقة المديرين عن أي مصادقة أخرى (مثل مصادقة الطلاب إذا كانت تتم عبر الويب).
    *   **`Admin\Auth\LoginController`:** تم إنشاء متحكم مخصص للتعامل مع منطق تسجيل دخول وخروج المديرين باستخدام `Auth::guard('admin_web')`.

*   **لطلاب الـ API:** استخدمنا Laravel Sanctum لتوفير مصادقة مبنية على التوكن.
    *   **تثبيت `laravel/sanctum`:**
        ```bash
        composer require laravel/sanctum
        php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
        php artisan migrate # لتشغيل هجرة personal_access_tokens
        ```
    *   **استخدام `HasApiTokens`:** تأكد من أن نموذج `App\Models\Student` يستخدم trait `Laravel\Sanctum\HasApiTokens`.
    *   **`Api\AuthController`:** تم إنشاء متحكم خاص للتعامل مع تسجيل دخول وخروج الطلاب عبر الـ API باستخدام `Auth::guard('sanctum')` وإنشاء/إلغاء توكنات Sanctum.
    *   **حماية مسارات الـ API:** تم وضع المسارات التي تتطلب مصادقة الطالب ضمن مجموعة مسارات تستخدم middleware `auth:sanctum` في `routes/api.php`.

**الـ Middleware: طبقة الفحص قبل الوصول إلى المتحكم**

الـ Middleware هي فلاتر تمر عبرها طلبات HTTP قبل أن تصل إلى دالة المتحكم، أو بعد معالجة الطلب وقبل إرسال الاستجابة. استخدمناها لـ:

*   **`auth:admin_web`:** لحماية مسارات لوحة تحكم الإدارة والتأكد من أن المستخدم مسجل دخوله كمدير. يتم تعريف هذا في `app/Http/Kernel.php` واستخدامه في конструкторы المتحكمات أو مجموعات المسارات.
*   **`guest:admin_web`:** للتأكد من أن المستخدم غير مسجل دخوله (مهم لصفحة تسجيل الدخول نفسها).
*   **`auth:sanctum`:** لحماية مسارات الـ API والتأكد من أن الطلب يحتوي على توكن Sanctum صالح يخص طالبًا مسجلاً.

**الـ Form Requests: التحقق من صحة البيانات بأسلوب منظم**

الـ Form Requests هي فلاسيس مخصصة (في مجلد `app/Http/Requests`) تُستخدم لتنظيم منطق التحقق من صحة البيانات المرسلة في الطلبات (خاصة لنماذج HTML أو طلبات API التي تتطلب التحقق المعقد). كل Form Request:

*   يحتوي على دالة `authorize()` لتحديد ما إذا كان المستخدم الحالي مصرحًا له بتقديم هذا الطلب.
*   يحتوي على دالة `rules()` لتعريف قواعد التحقق لجميع الحقول المتوقعة.

استخدمناها في متحكمات لوحة تحكم الإدارة (مثل `StoreFacultyRequest`, `UpdateProjectRequest`, إلخ) لضمان أن البيانات التي يتم إرسالها لإنشاء أو تحديث السجلات تتوافق مع قواعد البيانات ومتطلبات التطبيق. يسهل هذا فصل منطق التحقق عن المتحكم ويجعل الكود أنظف.

**الـ API Resources: تنسيق الاستجابات بأسلوب موحد**

الـ API Resources هي فلاسيس (في مجلد `app/Http/Resources`) تُستخدم لتحويل نماذج Eloquent إلى مصفوفات (أو JSON) جاهزة للإرسال في استجابات الـ API. استخدمناها لـ:

*   **تحديد الحقول:** نتحكم بدقة في الحقول التي يتم عرضها للعميل (تطبيق الموبايل).
*   **تنسيق البيانات:** يمكن تحويل أنواع البيانات (مثل التواريخ إلى سلاسل نصية بتنسيق ISO 8601)، وإضافة حقول محسوبة.
*   **تحميل العلاقات:** يمكن تضمين علاقات مرتبطة (باستخدام `whenLoaded()`) وتنسيقها باستخدام Resources أخرى.
*   **تقليل البيانات:** يمكن إنشاء Resources مُلخصة (Summary Resources) لعرض البيانات الأساسية فقط عند الحاجة.
*   **Collection Resources:** تُستخدم لتنسيق مجموعات من النماذج (مثل قائمة الاختصاصات) وتضمين بيانات التصفح.

كل نموذج بيانات يتم إرجاعه من الـ API (Student, Course, Event, إلخ) يمر عبر الـ Resource المقابل له لضمان توحيد بنية الاستجابة وتوفير البيانات بالصيغة المطلوبة لتطبيق الموبايل.

في الختام، مشروع دليل الطالب يعتمد على التفاعل بين هذه المكونات الأساسية في Laravel. النماذج توفر واجهة للبيانات، المتحكمات تعالج طلبات المستخدم، المصادقة تحمي الوصول، Middleware يطبق القواعد قبل الوصول للمتحكم، Form Requests تتحقق من المدخلات، و API Resources تنسق المخرجات لتطبيق الموبايل. هذا الهيكل يوفر أساسًا قويًا وقابلاً للتوسع لتطوير التطبيق بشكل كامل.
